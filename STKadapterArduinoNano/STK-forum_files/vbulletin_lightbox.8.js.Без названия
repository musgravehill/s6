/*======================================================================*\
|| #################################################################### ||
|| # ---------------------------------------------------------------- # ||
|| # This file may not be redistributed in whole or significant part. # ||
|| # ---------------- VBULLETIN IS NOT FREE SOFTWARE ---------------- # ||
|| # http://www.vbulletin.com | http://www.vbulletin.com/license.html # ||
|| #################################################################### ||
\*======================================================================*/
function vB_Lightbox(e,t,n,r){this.minborderW=200;this.minborderH=180;this.mindimension=0;this.event_click=1;this.event_hover=2;this.click_triggered=false;this.events_enabled=false;this.element=e;this.timeout=null;this.imageloader=null;this.status=0;this.active=false;this.ajax_req=null;this.feature_ajax_req=null;this.cursor=null;this.link=null;this.date=null;this.time=null;this.name=null;this.html=null;this.loader_link=null;this.loader_height=null;this.loader_width=null;this.lightbox=null;this.closebtn=null;this.img=null;this.uniqueid=t;this.containerid=n;if(r&this.event_hover){YAHOO.util.Event.on(this.element,"mouseover",this.countdown,this,true);YAHOO.util.Event.on(this.element,"mouseout",this.halt,this,true)}if(r&this.event_click){YAHOO.util.Event.on(this.element,"click",this.image_click,this,true)}}function sortNumber(e,t){return e-t}function is_lightbox_element(e){return typeof e.getAttribute("rel")=="string"&&e.getAttribute("rel").match(/Lightbox[_]?(\d*)?/)}function init_postbit_lightbox(e,t,n){var r=userAgent.match(/applewebkit\/([0-9]+)/);if(r&&r[1]<522){return}if(Lightbox_event_default===null){Lightbox_event_default=t}if(typeof t=="undefined"||t===false){t=Lightbox_event_default?Lightbox_event_default:1+2}var i=YAHOO.util.Dom.getElementsBy(is_lightbox_element,"a",e);for(var s=0;s<i.length;s++){var o=i[s].getAttribute("rel").match(/Lightbox[_]?(\d*)?/).pop();o=o?o:0;Lightboxes[s]=new vB_Lightbox(i[s],s,o,t);if(!Lightbox_map[o]||n){Lightbox_map[o]=new vB_Lightbox_Container(s);n=false}Lightbox_map[o][s]=s;if(Lightbox_map[o].firstid>s){Lightbox_map[o].firstid=parseInt(s)}else if(Lightbox_map[o].lastid<s){Lightbox_map[o].lastid=parseInt(s)}}}vBulletin.events.systemInit.subscribe(function(){if(vBulletin.elements.vB_Lightbox_Container){for(var e=0;e<vBulletin.elements.vB_Lightbox_Container.length;e++){var t=vBulletin.elements.vB_Lightbox_Container[e];init_postbit_lightbox(t[0],t[1])}vBulletin.elements.vB_Lightbox_Container=null}});var Lightboxes=new Array;var Lightbox_overlay=null;var Lightbox_overlay_select_handler=null;var Lightbox_event_default=null;var Lightbox_current=null;var Lightbox_map={};vB_Lightbox.prototype.set_status=function(e,t){console.log("vB_Lightbox :: Set status = %d (%s)",e,t);this.status=e};vB_Lightbox.prototype.check_status=function(e){if(this.status>=e){return true}else{console.warn("Checked status for %d, found %d",e,this.status);return false}};vB_Lightbox.prototype.countdown=function(e){if(!this.active){this.set_status(1,"countdown");this.cursor=YAHOO.util.Dom.getStyle(this.element,"cursor");this.element.style.cursor="wait";this.click_triggered=false;this.timeout=setTimeout("Lightboxes['"+this.uniqueid+"'].load_lightbox();",1500)}};vB_Lightbox.prototype.halt=function(e){if(this.status<2){this.set_status(0,"halt")}clearTimeout(this.timeout);this.element.style.cursor=this.cursor};vB_Lightbox.prototype.image_click=function(e){if(e.ctrlKey||e.shiftKey){return true}this.click_triggered=true;this.load_lightbox(e)};vB_Lightbox.prototype.load_lightbox=function(e){if(this.check_status(0)&&!YAHOO.util.Connect.isCallInProgress(this.ajax_req)){this.set_status(2,"load_lightbox 1");if(Lightbox_current&&Lightbox_current.loader_link){Lightbox_current.img.src=Lightbox_current.loader_link;Lightbox_current.img.width=Lightbox_current.loader_width;Lightbox_current.img.height=Lightbox_current.loader_height;this.center_element_in_bars(Lightbox_current.lightbox)}if(e){YAHOO.util.Event.stopEvent(e)}if(this.timeout){clearTimeout(this.timeout);this.element.style.cursor=this.cursor}if(this.html==null){var t=this.element.getAttribute("href");var n=t.substr(t.indexOf("?")+1)+"&securitytoken="+SECURITYTOKEN+"&ajax=1&uniqueid="+this.uniqueid;var r=parseInt(this.uniqueid-Lightbox_map[this.containerid].firstid)+1;var i=parseInt(Lightbox_map[this.containerid].lastid-Lightbox_map[this.containerid].firstid)+1;if(Lightbox_map[this.containerid].lastid>this.uniqueid){n=n+"&last=1&next=1"}if(Lightbox_map[this.containerid].firstid<this.uniqueid){n=n+"&prev=1&first=1"}n=n+"&total="+i;n=n+"&current="+r;this.show_overlay();try{this.ajax_req=YAHOO.util.Connect.asyncRequest("POST",t,{success:this.handle_ajax_response,failure:this.handle_ajax_error,scope:this,timeout:vB_Default_Timeout},n)}catch(e){var s=t.substr(0,t.indexOf("?"));var o;if(o=s.match(/\/([^/]*attachment\.php)$/)){this.ajax_req=YAHOO.util.Connect.asyncRequest("POST",o[1],{success:this.handle_ajax_response,failure:this.handle_ajax_error,scope:this,timeout:vB_Default_Timeout},n)}else{if(this.click_triggered){window.location=t}}}}else{this.set_status(3,"load_lightbox 2");this.show_lightbox()}}};vB_Lightbox.prototype.handle_ajax_error=function(e){vBulletin_AJAX_Error_Handler(e);if(this.click_triggered){window.location=this.element.getAttribute("href")}};vB_Lightbox.prototype.handle_ajax_response=function(e){if(!this.check_status(2)){return}if(e.responseXML){var t=e.responseXML.getElementsByTagName("error");if(t.length){this.set_status(0,"handle_ajax_response - error");if(t[0].textContent=="notimage"){console.warn("Attempted to load non-image (.%s) into lightbox. Aborted.",e.responseXML.getElementsByTagName("extension")[0].textContent)}else{alert(t[0].textContent.replace(/<(\/|[a-z]+)[^>]+>/g,""))}return false}var n=e.responseXML.getElementsByTagName("link");if(n.length){this.set_status(3,"handle_ajax_response - success");this.show_overlay();this.link=n[0].textContent;this.imageloader=new Image;YAHOO.util.Event.on(this.imageloader,"load",this.show_lightbox,this,true);var r=new Array("date","time","name","html");for(var i=0;i<r.length;i++){this[r[i]]=e.responseXML.getElementsByTagName(r[i])[0].textContent}this.lightbox=document.body.appendChild(string_to_node(this.html));this.closebtn=YAHOO.util.Dom.get("lightboxbutton"+this.uniqueid);YAHOO.util.Event.on(this.closebtn,"click",this.click_close,this,true);this.prevbtn=YAHOO.util.Dom.get("lightboxprevbutton"+this.uniqueid);if(this.prevbtn){YAHOO.util.Event.on(this.prevbtn,"click",this.prev_lightbox,this,true)}this.nextbtn=YAHOO.util.Dom.get("lightboxnextbutton"+this.uniqueid);if(this.nextbtn){YAHOO.util.Event.on(this.nextbtn,"click",this.next_lightbox,this,true)}this.firstbtn=YAHOO.util.Dom.get("lightboxfirstbutton"+this.uniqueid);if(this.firstbtn){YAHOO.util.Event.on(this.firstbtn,"click",this.first_lightbox,this,true)}this.lastbtn=YAHOO.util.Dom.get("lightboxlastbutton"+this.uniqueid);if(this.lastbtn){YAHOO.util.Event.on(this.lastbtn,"click",this.last_lightbox,this,true)}this.popfeaturebtn=YAHOO.util.Dom.get("lightboxpopfeaturebutton"+this.uniqueid);if(this.popfeaturebtn){YAHOO.util.Event.on(this.popfeaturebtn,"click",this.popular_feature,this,true);YAHOO.util.Event.on(this.popfeaturebtn,"mouseover",this.popfeature_over,this.popfeaturebtn,true);YAHOO.util.Event.on(this.popfeaturebtn,"mouseout",this.popfeature_off,this.popfeaturebtn,true)}this.nofeaturebtn=YAHOO.util.Dom.get("lightboxnofeaturebutton"+this.uniqueid);if(this.nofeaturebtn){YAHOO.util.Event.on(this.nofeaturebtn,"click",this.never_feature,this,true);YAHOO.util.Event.on(this.nofeaturebtn,"mouseover",this.nofeature_over,this.nofeaturebtn,true);YAHOO.util.Event.on(this.nofeaturebtn,"mouseout",this.nofeature_off,this.nofeaturebtn,true)}this.neverfeaturelbl=YAHOO.util.Dom.get("lightboxneverfeatured"+this.uniqueid);this.popfeaturelbl=YAHOO.util.Dom.get("lightboxpopfeatured"+this.uniqueid);YAHOO.util.Event.on(YAHOO.util.Dom.get("lightboxlink"+this.uniqueid),"click",this.hide_lightbox,this,true);this.img=YAHOO.util.Dom.get("lightboximg"+this.uniqueid);this.loader_link=this.img.src;this.loader_width=this.img.width;this.loader_height=this.img.height;this.imageloader.src=this.link;this.show_lightbox()}else{if(this.click_triggered){window.location=imagelink}}}else{if(this.click_triggered){window.location=imagelink}}};vB_Lightbox.prototype.show_overlay=function(){if(this.check_status(2)){var e=fetch_viewport_info();if(Lightbox_overlay==null){Lightbox_overlay=document.createElement("div");Lightbox_overlay.id="Lightbox_overlay";var t={display:"none",position:"absolute",top:"0px",zIndex:1e3};if(document.dir=="rtl"){t.right="0px"}else{t.left="0px"}for(var n in t){if(YAHOO.lang.hasOwnProperty(t,n)){YAHOO.util.Dom.setStyle(Lightbox_overlay,n,t[n])}}Lightbox_overlay=document.body.appendChild(Lightbox_overlay);Lightbox_overlay_select_handler=new vB_Select_Overlay_Handler(Lightbox_overlay)}YAHOO.util.Dom.setStyle(Lightbox_overlay,"display","");YAHOO.util.Dom.setStyle(Lightbox_overlay,"width","100%");YAHOO.util.Dom.setStyle(Lightbox_overlay,"height","100%");YAHOO.util.Dom.setXY(Lightbox_overlay,[e.x,e.y]);Lightbox_overlay_select_handler.hide()}};vB_Lightbox.prototype.show_lightbox=function(){if(this.check_status(3)){if(Lightbox_current){Lightbox_current.hide_lightbox(false,this,true)}this.show_overlay();if(!this.imageloader.complete&&this.imageloader.readyState!="complete"){YAHOO.util.Event.removeListener(this.imageloader,"load",this.show_lightbox);YAHOO.util.Event.on(this.imageloader,"load",this.show_lightbox,this,true)}else{this.img.src=this.link;this.resize_image();YAHOO.util.Dom.setStyle(this.closebtn,"display","")}this.resize_text();YAHOO.util.Dom.setStyle(this.lightbox,"display","");YAHOO.util.Dom.setStyle(this.lightbox,"zIndex",1100);if(Lightbox_map[this.containerid].size()==1){YAHOO.util.Dom.setStyle(this.prevbtn,"display","none");YAHOO.util.Dom.setStyle(this.nextbtn,"display","none")}Lightbox_current=this;this.center_lightbox();this.active=true;this.enable_events()}};vB_Lightbox.prototype.hide_lightbox=function(e,t,n){if(e&&e.type=="keydown"&&e.keyCode!=27){return}this.set_status(0,"hide_lightbox");this.disable_events();this.active=false;YAHOO.util.Dom.setStyle(this.lightbox,"display","none");if(!n){YAHOO.util.Dom.setStyle(Lightbox_overlay,"display","none")}Lightbox_overlay_select_handler.show();Lightbox_current=null};vB_Lightbox.prototype.click_close=function(e){this.hide_lightbox(false,this,false);YAHOO.util.Event.preventDefault(e)};vB_Lightbox.prototype.next_lightbox=function(e){if(!YAHOO.util.Dom.hasClass(this.nextbtn,"lbnextdisabled")){var t=null;if(Lightbox_map[this.containerid][parseInt(this.uniqueid)+1]!=null){t=Lightboxes[parseInt(this.uniqueid)+1]}else{t=Lightboxes[Lightbox_map[this.containerid].first()]}t.load_lightbox()}YAHOO.util.Event.preventDefault(e)};vB_Lightbox.prototype.prev_lightbox=function(e){if(!YAHOO.util.Dom.hasClass(this.prevbtn,"lbprevdisabled")){var t=null;if(Lightbox_map[this.containerid][parseInt(this.uniqueid)-1]!=null){t=Lightboxes[parseInt(this.uniqueid)-1]}else{t=Lightboxes[Lightbox_map[this.containerid].last()]}t.load_lightbox()}YAHOO.util.Event.preventDefault(e)};vB_Lightbox.prototype.first_lightbox=function(e){var t=Lightboxes[Lightbox_map[this.containerid].firstid];t.load_lightbox()};vB_Lightbox.prototype.last_lightbox=function(e){var t=Lightboxes[Lightbox_map[this.containerid].lastid];t.load_lightbox()};vB_Lightbox.prototype.highlight_btn=function(){var e=YAHOO.util.Dom.getStyle(this,"color");var t=YAHOO.util.Dom.getStyle(this,"background-color");var n,r;n=e=="white"||e.toLowerCase()=="#ffffff"?"black":"white";r=t=="black"||t.toLowerCase()=="#000000"?"white":"black";YAHOO.util.Dom.setStyle(this,"color",n);YAHOO.util.Dom.setStyle(this,"background-color",r)};vB_Lightbox.prototype.center_lightbox=function(){this.center_element_in_bars(this.lightbox)};vB_Lightbox.prototype.center_element_in_bars=function(e){viewport_info=fetch_viewport_info();if(viewport_info.w < 436){YAHOO.util.Dom.setXY(e, [viewport_info.w / 2 + viewport_info.x - e.clientWidth / 2, (viewport_info.h - 91) / 2 + viewport_info.y - e.clientHeight / 2 + 25]);}else if(viewport_info.w < 770){YAHOO.util.Dom.setXY(e, [viewport_info.w / 2 + viewport_info.x - e.clientWidth / 2, (viewport_info.h - 9) / 2 + viewport_info.y - e.clientHeight / 2]);}else{YAHOO.util.Dom.setXY(e, [viewport_info.w / 2 + viewport_info.x - e.clientWidth / 2, (viewport_info.h - 157) / 2 + viewport_info.y - e.clientHeight / 2 + 50]);}};vB_Lightbox.prototype.handle_viewport_change=function(){this.resize_image();this.resize_text();this.center_lightbox();this.show_overlay()};vB_Lightbox.prototype.handle_viewport_change_ie=function(){setTimeout("Lightboxes['"+this.uniqueid+"'].handle_viewport_change();",100)};vB_Lightbox.prototype.resize_image=function(){var e=fetch_viewport_info();var t=this.imageloader.width;var n=this.imageloader.height;if(e.w<770){this.minborderW=5;} if(t>e.w-this.minborderW){t=e.w-this.minborderW;t=t<this.mindimension?this.mindimension:t;n=Math.ceil(this.imageloader.height*(t/this.imageloader.width))}var r=document.getElementById("description"+"_"+this.uniqueid);if(r){if(viewport_info.w < 436){this.minborderH = 150}else if(viewport_info.w < 770){this.minborderH = 120}else{this.minborderH = 235}}if(n>e.h-this.minborderH){n=e.h-this.minborderH;n=n<this.mindimension?this.mindimension:n;t=Math.ceil(this.imageloader.width*(n/this.imageloader.height))}this.img.setAttribute("width",t);this.img.setAttribute("height",n);this.img.setAttribute("title",this.name+"; \n"+this.imageloader.width+" x "+this.imageloader.height+" (@"+Math.ceil(t/this.imageloader.width*100)+"%)");if(t<this.imageloader.width||n<this.imageloader.height){console.info("vB_Lightbox :: Image original size: %dx%d, resizing to %dx%d",this.imageloader.width,this.imageloader.height,t,n)}};vB_Lightbox.prototype.popular_feature=function(e){var t=this.element.getAttribute("href");var n=t.substr(t.indexOf("?")+1);this.feature_ajax_req=YAHOO.util.Connect.asyncRequest("POST","ajax.php",{success:this.feature_handle_ajax_response,failure:this.feature_handle_ajax_error,scope:this,timeout:vB_Default_Timeout},"do=featureattachment&"+n+"&notfeatured="+0+"&securitytoken="+SECURITYTOKEN);YAHOO.util.Event.preventDefault(e)};vB_Lightbox.prototype.never_feature=function(e){var t=this.element.getAttribute("href");var n=t.substr(t.indexOf("?")+1);this.feature_ajax_req=YAHOO.util.Connect.asyncRequest("POST","ajax.php",{success:this.feature_handle_ajax_response,failure:this.feature_handle_ajax_error,scope:this,timeout:vB_Default_Timeout},"do=featureattachment&"+n+"&notfeatured="+1+"&securitytoken="+SECURITYTOKEN);YAHOO.util.Event.preventDefault(e)};vB_Lightbox.prototype.feature_handle_ajax_response=function(e){if(e.responseXML&&e.responseXML.getElementsByTagName("error")[0]){alert(e.responseXML.getElementsByTagName("error")[0].textContent)}else if(e.responseXML&&e.responseXML.getElementsByTagName("notfeatured")[0]){var t=e.responseXML.getElementsByTagName("notfeatured")[0].textContent;if(t=="0"){YAHOO.util.Dom.removeClass(this.nofeaturebtn,"lbnofeatureselected");YAHOO.util.Dom.addClass(this.popfeaturebtn,"lbpopfeatureselected")}else if(t=="1"){YAHOO.util.Dom.removeClass(this.popfeaturebtn,"lbpopfeatureselected");YAHOO.util.Dom.addClass(this.nofeaturebtn,"lbnofeatureselected")}}else{alert("Could not find the entry.  Please try again.")}this.set_feature_text();return};vB_Lightbox.prototype.feature_handle_ajax_error=function(e){alert("error updating entry")};vB_Lightbox.prototype.popfeature_over=function(){YAHOO.util.Dom.addClass(this,"lbpopfeaturehovered");Lightbox_current.set_feature_text()};vB_Lightbox.prototype.popfeature_off=function(){YAHOO.util.Dom.removeClass(this,"lbpopfeaturehovered");Lightbox_current.set_feature_text()};vB_Lightbox.prototype.nofeature_over=function(){YAHOO.util.Dom.addClass(this,"lbnofeaturehovered");Lightbox_current.set_feature_text()};vB_Lightbox.prototype.nofeature_off=function(){YAHOO.util.Dom.removeClass(this,"lbnofeaturehovered");Lightbox_current.set_feature_text()};vB_Lightbox.prototype.set_feature_text=function(){var e=-1;if(YAHOO.util.Dom.hasClass(this.popfeaturebtn,"lbpopfeaturehovered")){e=0}else if(YAHOO.util.Dom.hasClass(this.nofeaturebtn,"lbnofeaturehovered")){e=1}if(e<0){if(YAHOO.util.Dom.hasClass(this.popfeaturebtn,"lbpopfeatureselected")){e=0}else if(YAHOO.util.Dom.hasClass(this.nofeaturebtn,"lbnofeatureselected")){e=1}}YAHOO.util.Dom.setStyle(this.popfeaturelbl,"display","none");YAHOO.util.Dom.setStyle(this.neverfeaturelbl,"display","none");if(e==0){YAHOO.util.Dom.setStyle(this.popfeaturelbl,"display","inline-block")}else if(e==1){YAHOO.util.Dom.setStyle(this.neverfeaturelbl,"display","inline-block")}};vB_Lightbox.prototype.resize_text=function(){var e=this.img.getAttribute("width");var t=this.img.getAttribute("height");document.getElementById("details_"+this.uniqueid).style.width=e+"px";var n=document.getElementById("description"+"_"+this.uniqueid);if(n){n.style.width=e+"px"}};vB_Lightbox.prototype.enable_events=function(){if(!this.events_enabled){YAHOO.util.Event.on(window,"resize",is_ie?this.handle_viewport_change_ie:this.handle_viewport_change,this,true);YAHOO.util.Event.on(window,"scroll",this.hide_lightbox,this,true);YAHOO.util.Event.on(window,"keydown",this.hide_lightbox,this,true);YAHOO.util.Event.on(Lightbox_overlay,"click",this.hide_lightbox,this,true);this.events_enabled=true}};vB_Lightbox.prototype.disable_events=function(){if(this.events_enabled){YAHOO.util.Event.removeListener(window,"resize",is_ie?this.handle_viewport_change_ie:this.handle_viewport_change);YAHOO.util.Event.removeListener(window,"scroll",this.hide_lightbox);YAHOO.util.Event.removeListener(window,"keydown",this.hide_lightbox);YAHOO.util.Event.removeListener(Lightbox_overlay,"click",this.hide_lightbox);this.events_enabled=false}};vB_Lightbox_Container=function(e){this.firstid=parseInt(e);this.lastid=parseInt(e)};vB_Lightbox_Container.prototype.size=function(){var e=0;for(var t in this){if(YAHOO.lang.hasOwnProperty(this,t)){e++}}return e};vB_Lightbox_Container.prototype.first=function(){for(var e in this){if(YAHOO.lang.hasOwnProperty(this,e)){return e}}};vB_Lightbox_Container.prototype.last=function(){var e;for(var t in this){if(YAHOO.lang.hasOwnProperty(this,t)){e=t}}return e};vB_Lightbox_Container.prototype.find=function(e){var t=0;for(var n in this){if(YAHOO.lang.hasOwnProperty(this,n)){if(n==e){return t}t++}}return-1};